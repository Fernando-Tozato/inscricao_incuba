document.addEventListener('DOMContentLoaded', function ()  {
    turmas = window.turmas;
    input_nascimento = document.getElementById('id_nascimento');
    select_escolaridade = document.getElementById('id_escolaridade');
    select_curso = document.getElementById('id_curso');
    select_dias = document.getElementById('id_dias');
    select_horario = document.getElementById('id_horario');

    input_nascimento.addEventListener('blur', () => {
        let value = input_nascimento.value;

        if(value==='') {
            input_nascimento.classList.add('is-invalid');
            invalid_message(input_nascimento,'Data de nascimento é um campo obrigatório.');
            return;
        } else if(value.replace(/\D/g, '').length !== 8) {
            input_nascimento.classList.add('is-invalid');
            invalid_message(input_nascimento, 'Data inválida, verifique se foi escrita da maneira correta.');
            return
        }

        let data = value.split('/');

        try {
            idade = moment().diff(moment(data, 'DD/MM/YYYY'), 'years');
        } finally {
            if (idade && escolaridade) {
                definir_cursos();
            }
        }
    });

    select_escolaridade.addEventListener('blur', () => {
        escolaridade = select_escolaridade.value;

        if(escolaridade==='') {
            select_escolaridade.classList.add('is-invalid');
            invalid_message(select_escolaridade, 'Escolaridade  é um campo obrigatório.');
            return;
        }

        if (idade && escolaridade) {
            definir_cursos();
        }
    });

    select_curso.addEventListener('change', () => {
        let curso = select_curso.value;
        let dias = [];

        if(curso==='') {
            select_curso.classList.add('is-invalid');
            invalid_message(select_curso, 'Curso  é um campo obrigatório.');
            return;
        }

        for (let i = 0; i < turmas.length; i++) {
            let turma = turmas[i];
            if (idade >= turma['idade'] && escolaridade >= turma['escolaridade']) {
                if (curso === turma['curso']) {
                    let dia = turma['dias'];

                    if(!dias.includes(dia)){
                        dias.push(dia);
                    }
                }
            }
        }
        add_options(select_dias, dias);
    });

    select_dias.addEventListener('change', () => {
        let curso = select_curso.value;
        let dias = select_dias.value;
        let horarios = [];

        if(dias==='') {
            select_dias.classList.add('is-invalid');
            invalid_message(select_dias, 'Dias  é um campo obrigatório.');
            return;
        }

        for (let i = 0; i < turmas.length; i++) {
            let turma = turmas[i];
            if (idade >= turma['idade'] && escolaridade >= turma['escolaridade']) {
                if (curso === turma['curso']) {
                    if (dias === turma['dias']) {
                        let horario = turma['horario'];

                        if(!horarios.includes(horario)){
                            horarios.push(horario);
                        }
                    }
                }
            }
        }
        add_options(select_horario, horarios);
    });
});

function definir_cursos(){
    let cursos = [];

    for (let i = 0; i < turmas.length; i++) {
        let turma = turmas[i];
        if (idade >= turma['idade'] && escolaridade >= turma['escolaridade']) {
            let curso = turma['curso'];

            if(!cursos.includes(curso)){
                cursos.push(curso);
            }
        }
    }
    add_options(select_curso, cursos);
}

function add_options(select, options){
    select.innerHTML = '<option value selected>Selecione...</option>';
    for(let i = 0; i < options.length; i++) {
        let option = options[i];
        let new_opt = document.createElement('option');
        new_opt.text = option;
        new_opt.value = option;
        select.appendChild(new_opt);
    }
    select.disabled = false;
    console.log(select.disabled)
}